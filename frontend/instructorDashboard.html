<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CliqueMe Instructor Dashboard</title>
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Muted Button Styles */
        .btn-primary {
            background-color: #8B3A3A; /* Muted wine color */
            color: #EFDFBB; /* Dutch white text */
            border: none;
        }

        .btn-primary:hover {
            background-color: #A05252; /* Slightly lighter wine color */
            color: #EFDFBB;
        }

        .btn-secondary {
            background-color: #EFDFBB; /* Dutch white background */
            color: #722F37; /* Wine-colored text */
            border: 1px solid #722F37;
        }

        .btn-secondary:hover {
            background-color: #E8D8B0; /* Slightly darker Dutch white */
            color: #722F37;
        }

        .btn-success {
            background-color: #8B3A3A; /* Muted wine color */
            color: #EFDFBB;
            border: none;
        }

        .btn-success:hover {
            background-color: #A05252; /* Slightly lighter wine color */
            color: #EFDFBB;
        }

        .btn-danger {
            background-color: #A05252; /* Softer red tone */
            color: #EFDFBB;
            border: none;
        }

        .btn-danger:hover {
            background-color: #C06060; /* Slightly lighter red */
            color: #EFDFBB;
        }

        /* Custom SweetAlert Popup */
        .swal2-custom-popup {
            border-radius: 10px;
            background-color: #FFFFFF; /* White background */
            color: #000000; /* Black text */
            font-family: 'Arial', sans-serif;
            border: 1px solid #000000; /* Black border */
        }

        /* Custom Confirm Button */
        .swal2-custom-confirm {
            background-color: #000000; /* Black */
            color: #FFFFFF; /* White text */
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 16px;
        }

        .swal2-custom-confirm:hover {
            background-color: #333333; /* Dark gray */
        }

        /* Custom Cancel Button */
        .swal2-custom-cancel {
            background-color: #F0F0F0; /* Light gray */
            color: #000000; /* Black text */
            border: 1px solid #000000;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 16px;
        }

        .swal2-custom-cancel:hover {
            background-color: #E0E0E0; /* Slightly darker gray */
        }

        /* Ensure inputs and selects in SweetAlert are the same size */
        .swal2-select {
            width: 100%; /* Match the width of the input box */
            padding: 10px; /* Add padding for consistency */
            font-size: 16px; /* Match the font size of the input box */
            box-sizing: border-box; /* Include padding and border in width calculation */
        }

        /* Custom styles */
        body {
            background-color: #EFDFBB;
        }

        .tab-content-section {
            display: none;
        }

        .tab-content-section.active {
            display: block;
        }

        .nav-link.active {
            font-weight: bold;
            text-decoration: underline;
        }
    </style>
</head>

<body style="background-color: #EFDFBB;">

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #722F37;">
        <div class="container-fluid">
            <!-- Add the SVG logo -->
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="./img/altLogo.svg" alt="Logo" height="40" class="me-2">
                Instructor Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-target="tabGroups">Manage Groups</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-target="tabSurveys">Create Surveys</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-target="tabClasses">My Classes</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-target="tabResponses">Survey Responses</a>
                    </li>
                    <!-- New Tab for Student Dashboard -->
                    <li class="nav-item">
                        <a class="nav-link" onclick="window.location.href = 'studentDashboard.html'" ;>Student Dashboard</a>
                    </li>
                </ul>
                <button id="btnLogout" class="btn btn-danger">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Page Content -->
    <div class="container mt-4">
        <!-- Manage Groups -->
        <div id="tabGroups" class="tab-content-section">
            <h2><i class="bi bi-people-fill"></i> Manage Groups</h2>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">View Students</h5>
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <label for="filterClass" class="form-label">Filter by Class:</label>
                            <select id="filterClass" class="form-select mb-3">
                                <option value="all" selected>All Classes</option>
                                <option value="class1">Class 1</option>
                                <option value="class2">Class 2</option>
                            </select>
                            <label for="filterGroup" class="form-label">Filter by Group:</label>
                            <select id="filterGroup" class="form-select">
                                <option value="all" selected>All Groups</option>
                                <option value="group1">Group 1</option>
                                <option value="group2">Group 2</option>
                            </select>
                        </div>
                        <!-- Add Project Button -->
                        <button id="btnAddNewGroup" class="btn btn-success btn-sm">
                            <i class="bi bi-plus"></i> Add Project
                        </button>
                    </div>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Class</th>
                                <th>Group</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTable">
                            <!-- Dynamically populated rows -->
                            <tr data-class="class1" data-group="group1">
                                <td>John Doe</td>
                                <td>john.doe@example.com</td>
                                <td>Class 1</td>
                                <td>Group 1</td>
                            </tr>
                            <tr data-class="class2" data-group="group2">
                                <td>Jane Smith</td>
                                <td>jane.smith@example.com</td>
                                <td>Class 2</td>
                                <td>Group 2</td>
                            </tr>
                            <tr data-class="class1" data-group="group2">
                                <td>Emily Johnson</td>
                                <td>emily.johnson@example.com</td>
                                <td>Class 1</td>
                                <td>Group 2</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Create Surveys -->
        <div id="tabSurveys" class="tab-content-section active">
            <h2><i class="bi bi-pencil-square"></i> Create Surveys</h2>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Create a New Survey</h5>
                    <form id="frmSurvey">
                        <div class="mb-3">
                            <label for="surveyTitle" class="form-label">Survey Title:</label>
                            <input type="text" id="surveyTitle" class="form-control" placeholder="Enter survey title" required>
                        </div>
                        <div class="mb-3">
                            <label for="classSelectSurvey" class="form-label">Select Class:</label>
                            <select id="classSelectSurvey" class="form-select">
                                <option value="" disabled selected>Loading classes...</option>
                            </select>
                        </div>
                        <div id="questionsContainer">
                            <h6>Questions:</h6>
                            <!-- Questions will be dynamically added here -->
                        </div>
                        <button type="button" class="btn btn-primary mb-3" id="btnAddQuestion">Add Question</button>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="reviewBeforePublish">
                            <label class="form-check-label" for="reviewBeforePublish">Review before publishing</label>
                        </div>
                        <button type="button" class="btn btn-primary mt-2" id="btnPreviewSurvey">Preview Survey</button>
                        <button type="submit" class="btn btn-success mt-2">Publish Survey</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- My Classes -->
        <div id="tabClasses" class="tab-content-section">
            <h2><i class="bi bi-person-circle"></i> My Classes</h2>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Manage Classes</h5>
                    <div class="d-flex flex-column align-items-start mb-3">
                        <div class="mb-2">
                            <label for="classFilter" class="form-label">Filter by Class:</label>
                            <select id="classFilter" class="form-select">
                                <option value="all" selected>All Classes</option>
                                <option value="class1">Class 1</option>
                                <option value="class2">Class 2</option>
                                <option value="class3">Class 3</option>
                            </select>
                        </div>
                        <button id="btnAddClass" class="btn btn-success btn-sm mb-2">
                            <i class="bi bi-plus"></i> Add Class
                        </button>
                    </div>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Class Name</th>
                                <th>Description</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Active</th>

                            </tr>
                        </thead>
                        <tbody id="studentTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Survey Responses -->
        <div id="tabResponses" class="tab-content-section">
            <h2><i class="bi bi-graph-up"></i> Survey Responses</h2>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">View Responses</h5>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Survey</th>
                                <th>Class</th>
                                <th>Review Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="responsesTable">
                            <!-- Dynamically populated rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tabResponses" class="tab-content-section">
            <h2><i class="bi bi-graph-up"></i> Survey Responses</h2>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">View Responses</h5>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <label for="responseClassFilter" class="form-label">Filter by Class:</label>
                            <select id="responseClassFilter" class="form-select">
                                <option value="all" selected>All Classes</option>
                                <option value="class1">Class 1</option>
                                <option value="class2">Class 2</option>
                                <option value="class3">Class 3</option>
                            </select>
                        </div>
                        <div>
                            <label for="responseSurveyFilter" class="form-label">Filter by Survey:</label>
                            <select id="responseSurveyFilter" class="form-select">
                                <option value="all" selected>All Surveys</option>
                                <option value="survey1">Survey 1</option>
                                <option value="survey2">Survey 2</option>
                            </select>
                        </div>
                    </div>
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Survey</th>
                                <th>Class</th>
                                <th>Review Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="responsesTable">
                            <!-- Dynamically populated rows -->
                            <tr data-class="class1" data-survey="survey1">
                                <td>John Doe</td>
                                <td>Survey 1</td>
                                <td>Class 1</td>
                                <td>submitted</td>
                                <td>
                                    <button class="btn btn-primary btn-sm btnReview" data-student="John Doe" data-survey="survey1">Review</button>
                                    <button class="btn btn-success btn-sm btnSendScore" data-student="John Doe" data-survey="survey1">Send Score</button>
                                </td>
                            </tr>
                            <tr data-class="class2" data-survey="survey2">
                                <td>Jane Smith</td>
                                <td>Survey 2</td>
                                <td>Class 2</td>
                                <td>submitted</td>
                                <td>
                                    <button class="btn btn-primary btn-sm btnReview" data-student="Jane Smith" data-survey="survey2">Review</button>
                                    <button class="btn btn-success btn-sm btnSendScore" data-student="Jane Smith" data-survey="survey2">Send Score</button>
                                </td>
                            </tr>
                            <tr data-class="class1" data-survey="survey2">
                                <td>John Doe</td>
                                <td>Survey 2</td>
                                <td>Class 1</td>
                                <td>submitted</td>
                                <td>
                                    <button class="btn btn-primary btn-sm btnReview" data-student="John Doe" data-survey="survey2">Review</button>
                                    <button class="btn btn-success btn-sm btnSendScore" data-student="John Doe" data-survey="survey2">Send Score</button>
                                </td>
                            </tr>
                            <tr data-class="class1" data-survey="survey1">
                                <td>John Doe</td>
                                <td>Survey 1</td>
                                <td>Class 1</td>
                                <td>submitted</td>
                                <td>
                                    <button class="btn btn-primary btn-sm btnReview" data-survey="12345" data-student="user1">Review</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    <script>    
        const tabLinks = document.querySelectorAll('.nav-link');
        const contentSections = document.querySelectorAll('.tab-content-section');

        tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();

                // Remove active class from all links
                tabLinks.forEach(l => l.classList.remove('active'));

                // Hide all sections
                contentSections.forEach(section => section.classList.remove('active'));

                // Activate the clicked tab and its content
                const targetId = link.getAttribute('data-target');
                document.getElementById(targetId).classList.add('active');
                link.classList.add('active');
            });
        });

        // Filter student table by class
        const classFilter = document.getElementById('classFilter');
        const studentTableRows = document.querySelectorAll('#studentTable tr');

        classFilter.addEventListener('change', () => {
            const selectedClass = classFilter.value;

            studentTableRows.forEach(row => {
                const rowClass = row.getAttribute('data-class');
                if (selectedClass === 'all' || rowClass === selectedClass) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Add a new class using SweetAlert
        const btnAddClass = document.getElementById('btnAddClass');

        btnAddClass.addEventListener('click', async () => {
            const { value: className } = await Swal.fire({
                title: 'Add a New Class',
                input: 'text',
                inputLabel: 'Class Name',
                inputPlaceholder: 'Enter the class name',
                showCancelButton: true,
                confirmButtonText: 'Add Class',
                inputValidator: (value) => {
                    if (!value) {
                        return 'Please enter a class name!';
                    }
                }
            });

            if (className) {
                // Generate a random 6-digit alphanumeric code
                const classCode = Math.random().toString(36).substring(2, 8).toUpperCase();

                // Add the new class to the dropdown filter
                const newOption = document.createElement('option');
                newOption.value = className.toLowerCase().replace(/\s+/g, '');
                newOption.textContent = className;
                classFilter.appendChild(newOption);

                // Show success message with the generated code
                await Swal.fire({
                    title: 'Class Added',
                    html: `
                        <p>The class "<strong>${className}</strong>" has been added successfully.</p>
                        <p><strong>Class Code:</strong> ${classCode}</p>
                        
                    `,
                    icon: 'success',
                    showConfirmButton: false,
                    didRender: () => {
                        // Add event listener to the "View Code" button
                        const btnViewCode = document.getElementById('btnViewCode');
                        btnViewCode.addEventListener('click', () => {
                            Swal.fire('Class Code', 'Placeholder for code', 'info');
                        });
                    }
                });
            }
        });

        // Add a new group(this doesn't add a new group, it adds a new project) using SweetAlert
        const btnAddNewGroup = document.getElementById('btnAddNewGroup');

        btnAddNewGroup.addEventListener('click', async () => {
            const { value: formValues } = await Swal.fire({
                title: '<h3 style="color: #000000;">Create a New Project</h3>',
                html: `
                    <div style="text-align: left;">
                        <label for="groupClassSelect" class="form-label" style="color: #000000;">Select Class:</label>
                        <select id="groupClassSelect" class="swal2-select form-select" style="width: auto;">
                            <option value="" disabled selected>Select a class</option>
                            <option value="class1">Class 1</option>
                            <option value="class2">Class 2</option>
                        </select>
                        <label for="projectName" class="form-label mt-3" style="color: #000000;">Project Name:</label>
                        <input id="projectName" class="swal2-input" placeholder="Enter project name">
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="randomAssignment">
                            <label class="form-check-label" for="randomAssignment" style="color: #000000;">Randomly Assign Students</label>
                        </div>
                    </div>
                `,
                icon: 'info',
                confirmButtonText: 'Create Project',
                confirmButtonColor: '#000000', // Black
                cancelButtonText: 'Cancel',
                cancelButtonColor: '#F0F0F0', // Light gray
                showCancelButton: true,
                focusConfirm: false,
                customClass: {
                    popup: 'swal2-custom-popup',
                    confirmButton: 'swal2-custom-confirm',
                    cancelButton: 'swal2-custom-cancel'
                },
                preConfirm: () => {
                    const groupClass = document.getElementById('groupClassSelect').value;
                    const projectName = document.getElementById('projectName').value;
                    const randomAssignment = document.getElementById('randomAssignment').checked;

                    if (!groupClass || !projectName) {
                        Swal.showValidationMessage('Please select a class and enter a project name');
                    }

                    return { groupClass, projectName, randomAssignment };
                }
            });

            if (formValues) {
                const { groupClass, projectName, randomAssignment } = formValues;

                // Display confirmation
                Swal.fire({
                    title: 'Project Created!',
                    html: `
                        <p><strong>Class:</strong> ${groupClass}</p>
                        <p><strong>Project:</strong> ${projectName}</p>
                        <p><strong>Random Assignment:</strong> ${randomAssignment ? 'Yes' : 'No'}</p>
                    `,
                    icon: 'success',
                    confirmButtonColor: '#000000' // Black
                });

                // Add logic here to save the new project to the database or update the UI
            }
        });

       

        // Filter students by class and group
        const filterClass = document.getElementById('filterClass');
        const filterGroup = document.getElementById('filterGroup');
        const studentsTableRows = document.querySelectorAll('#studentsTable tr');

        function filterStudents() {
            const selectedClass = filterClass.value;
            const selectedGroup = filterGroup.value;

            studentsTableRows.forEach(row => {
                const rowClass = row.getAttribute('data-class');
                const rowGroup = row.getAttribute('data-group');

                if (
                    (selectedClass === 'all' || rowClass === selectedClass) &&
                    (selectedGroup === 'all' || rowGroup === selectedGroup)
                ) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        filterClass.addEventListener('change', filterStudents);
        filterGroup.addEventListener('change', filterStudents);

 
        // Add event listeners to all "Send Score" buttons
        document.querySelectorAll('.btnSendScore').forEach(button => {
            button.addEventListener('click', async (e) => {
                const studentName = e.target.getAttribute('data-student');
                const surveyName = e.target.getAttribute('data-survey');

                const { value: sendOption } = await Swal.fire({
                    title: 'Send Score',
                    text: `Do you want to send the score for ${studentName} (${surveyName}) anonymously?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Send Anonymously',
                    cancelButtonText: 'Send with Name',
                    reverseButtons: true,
                });

                if (sendOption) {
                    // Logic for sending the score anonymously
                    Swal.fire('Score Sent', `The score for ${studentName} has been sent anonymously.`, 'success');
                } else if (sendOption === false) {
                    // Logic for sending the score with the student's name
                    Swal.fire('Score Sent', `The score for ${studentName} has been sent with their name.`, 'success');
                }
            });
        });

        document.querySelectorAll('.btnReview').forEach(button => {
            button.addEventListener('click', async (e) => {
                const surveyId = e.target.getAttribute('data-survey');

                try {
                    const response = await fetch(`http://localhost:8000/survey/${surveyId}/responses`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch survey responses');
                    }

                    const surveyData = await response.json();

                    // Format the survey with responses for display
                    let surveyHTML = '<h3>Survey Responses</h3><hr>';
                    surveyData.forEach((question, index) => {
                        surveyHTML += `<div class="mb-3">
                            <h5>${index + 1}. ${question.questionTitle}</h5>
                            <ul>`;
                        question.responses.forEach(response => {
                            surveyHTML += `<li><strong>${response.studentName}:</strong> ${response.contents}</li>`;
                        });
                        surveyHTML += `</ul></div>`;
                    });

                    // Display the survey with responses in a SweetAlert
                    Swal.fire({
                        title: 'Survey Responses',
                        html: surveyHTML,
                        width: '80%',
                        customClass: {
                            popup: 'swal2-custom-popup',
                        },
                        confirmButtonText: 'Close',
                    });
                } catch (error) {
                    console.error('Error fetching survey responses:', error);
                    Swal.fire('Error', 'Failed to load survey responses. Please try again later.', 'error');
                }
            });
        });


        async function validateToken() {
                try {
                    const response = await fetch(`${URL}/ValidateToken`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`, // Include the JWT in the Authorization header
                        },
                    });

                    if (!response.ok) {
                        throw new Error("Invalid or expired token.");
                    }

                    const result = await response.json();
                    if (result.message !== 'Token and session are valid.') {
                        throw new Error("Invalid or expired token.");
                    }
                } catch (error) {
                    console.error("Error during token validation:", error);
                    Swal.fire({
                        title: "Session Expired",
                        text: "Your session has expired. Please log in again.",
                        icon: "error",
                        confirmButtonText: "Login",
                        allowOutsideClick: false,
                    }).then(() => {
                        localStorage.removeItem('jwt'); // Clear the JWT from storage
                        window.location.href = "../frontend/index.html"; // Redirect to login page
                    });
                }
            }

    </script>
    <script  src="../backend/js/InstructorDashboard.js"></script>
    <!-- Survey Script -->
    <script>
        const questionsContainer = document.getElementById('questionsContainer');
        const btnAddQuestion = document.getElementById('btnAddQuestion');
        const frmSurvey = document.getElementById('frmSurvey');

        let questionCount = 0;
        let questions = []; // Array to store questions

        // Add a question to the survey
        btnAddQuestion.addEventListener('click', async () => {
            const { value: formValues } = await Swal.fire({
                title: 'Add a Question',
                html: `
                    <label for="questionTitle" class="form-label">Please enter the question title:</label>
                    <input id="questionTitle" class="swal2-input" placeholder="Enter question title">
                    <label for="questionType" class="form-label mt-2">Please select the question type:</label>
                    <select id="questionType" class="swal2-select">
                        <option value="multipleChoice">Multiple Choice</option>
                        <option value="likert">Likert Scale</option>
                        <option value="shortAnswer">Short Answer</option>
                    </select>
                    <div id="answerChoicesContainer" style="display: none; margin-top: 10px;">
                        <label for="answerChoices" class="form-label">Add Answer Choices:</label>
                        <div id="answerChoices">
                            <input type="text" class="swal2-input" placeholder="Answer Choice 1">
                        </div>
                        <button type="button" id="addAnswerChoice" class="btn btn-secondary btn-sm mt-2">Add Another Choice</button>
                    </div>
                `,
                didOpen: () => {
                    const questionTypeSelect = document.getElementById('questionType');
                    const answerChoicesContainer = document.getElementById('answerChoicesContainer');
                    const addAnswerChoiceButton = document.getElementById('addAnswerChoice');
                    const answerChoicesDiv = document.getElementById('answerChoices');

                    // Show or hide the answer choices section based on the question type
                    questionTypeSelect.addEventListener('change', () => {
                        if (questionTypeSelect.value === 'multipleChoice') {
                            answerChoicesContainer.style.display = 'block';
                        } else {
                            answerChoicesContainer.style.display = 'none';
                        }
                    });

                    // Add new input fields for answer choices
                    addAnswerChoiceButton.addEventListener('click', () => {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'swal2-input';
                        input.placeholder = `Answer Choice ${answerChoicesDiv.children.length + 1}`;
                        answerChoicesDiv.appendChild(input);
                    });
                },
                focusConfirm: false,
                preConfirm: () => {
                    const questionTitle = document.getElementById('questionTitle').value;
                    const questionType = document.getElementById('questionType').value;

                    if (!questionTitle || !questionType) {
                        Swal.showValidationMessage('Please enter a question title and select a question type');
                    }

                    // Collect answer choices if the question type is multiple choice
                    let answerChoices = [];
                    if (questionType === 'multipleChoice') {
                        const answerInputs = document.querySelectorAll('#answerChoices input');
                        answerChoices = Array.from(answerInputs)
                            .map(input => input.value.trim())
                            .filter(choice => choice !== '');
                        if (answerChoices.length < 2) {
                            Swal.showValidationMessage('Please provide at least two answer choices for multiple-choice questions');
                        }
                    } else {
                        // Add a placeholder answer choice for likert and short answer questions
                        answerChoices = ['None Needed'];
                    }

                    return { questionTitle, questionType, answerChoices };
                }
            });

            if (formValues) {
                questionCount++;
                questions.push(formValues); // Add the question to the array
                const questionDiv = document.createElement('div');
                questionDiv.classList.add('mb-3');
                questionDiv.innerHTML = `
                    <h6>Question ${questionCount}: ${formValues.questionTitle}</h6>
                    <p><strong>Type:</strong> ${formValues.questionType}</p>
                    ${
                        formValues.answerChoices && formValues.answerChoices.length > 0
                            ? `<p><strong>Answer Choices:</strong> ${formValues.answerChoices.join(', ')}</p>`
                            : ''
                    }
                `;
                questionsContainer.appendChild(questionDiv);
            }
        });

        // Submit the survey
        frmSurvey.addEventListener('submit', async (e) => {
            e.preventDefault();

            const surveyTitle = document.getElementById('surveyTitle').value;
            const selectedClass = document.getElementById('classSelectSurvey').value;

            if (!surveyTitle || !selectedClass) {
                Swal.fire('Error', 'Please fill out all required fields.', 'error');
                return;
            }

            try {
                const response = await fetch('http://localhost:8000/survey', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Name: surveyTitle,
                        ClassID: selectedClass,
                        Questions: questions // Send the questions array
                    })
                });

                if (response.ok) {
                    Swal.fire('Survey Published!', 'Your survey has been successfully published.', 'success');
                    frmSurvey.reset();
                    questionsContainer.innerHTML = ''; // Clear questions
                    questionCount = 0;
                    questions = []; // Reset the questions array
                } else {
                    const error = await response.json();
                    Swal.fire('Error', error.message || 'Failed to publish survey.', 'error');
                }
            } catch (error) {
                console.error('Error creating survey:', error);
                Swal.fire('Error', 'An unexpected error occurred. Please try again later.', 'error');
            }
        });

        // Fetch classes the user teaches and populate the dropdown
        async function fetchClasses() {
            try {
                const response = await fetch('http://localhost:8000/classes/user1');
                if (!response.ok) {
                    throw new Error('Failed to fetch classes');
                }
                const classes = await response.json();

                const classSelect = document.getElementById('classSelectSurvey');
                classSelect.innerHTML = ''; // Clear existing options

                if (classes.length === 0) {
                    classSelect.innerHTML = '<option value="" disabled>No classes available</option>';
                    return;
                }

                // Populate the dropdown with class names
                classes.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className; // Use the class name directly as the value
                    option.textContent = className; // Display the class name
                    classSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching classes:', error);
                const classSelect = document.getElementById('classSelectSurvey');
                classSelect.innerHTML = '<option value="" disabled>Error loading classes</option>';
            }
        }

        // Call fetchClasses when the page loads
        document.addEventListener('DOMContentLoaded', fetchClasses);

        const btnPreviewSurvey = document.getElementById('btnPreviewSurvey');

        btnPreviewSurvey.addEventListener('click', () => {
            if (questions.length === 0) {
                Swal.fire('No Questions', 'Please add at least one question to preview the survey.', 'info');
                return;
            }

            const surveyTitle = document.getElementById('surveyTitle').value;
            const selectedClass = document.getElementById('classSelectSurvey').value;

            if (!surveyTitle || !selectedClass) {
                Swal.fire('Error', 'Please fill out the survey title and select a class before previewing.', 'error');
                return;
            }

            // Format the survey preview
            let surveyPreviewHTML = `
                <h3>${surveyTitle}</h3>
                <p><strong>Class:</strong> ${selectedClass}</p>
                <hr>
                <h5>Questions:</h5>
                <ol>
            `;

            questions.forEach((question, index) => {
                surveyPreviewHTML += `<li><p><strong>${question.questionTitle}</strong></p>`;

                if (question.questionType === 'multipleChoice') {
                    // Display multiple choice options with aligned letters
                    surveyPreviewHTML += `
                        <ul style="list-style-type: none; padding-left: 20px; margin: 0;">
                    `;
                    question.answerChoices.forEach((choice, i) => {
                        const letter = String.fromCharCode(65 + i); // Convert index to A, B, C, etc.
                        surveyPreviewHTML += `
                            <li style="display: flex; align-items: center; margin-bottom: 5px;">
                                <span style="width: 20px; font-weight: bold;">${letter}.</span>
                                <span>${choice}</span>
                            </li>
                        `;
                    });
                    surveyPreviewHTML += '</ul>';
                } else if (question.questionType === 'shortAnswer') {
                    // Display a text box for short answer
                    surveyPreviewHTML += '<input type="text" class="form-control" placeholder="Your answer here" disabled>';
                } else if (question.questionType === 'likert') {
                    // Display a Likert scale (1-5)
                    surveyPreviewHTML += `
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label>1</label>
                            <input type="radio" name="likert${index}" value="1" disabled>
                            <label>2</label>
                            <input type="radio" name="likert${index}" value="2" disabled>
                            <label>3</label>
                            <input type="radio" name="likert${index}" value="3" disabled>
                            <label>4</label>
                            <input type="radio" name="likert${index}" value="4" disabled>
                            <label>5</label>
                            <input type="radio" name="likert${index}" value="5" disabled>
                        </div>
                    `;
                }

                surveyPreviewHTML += '</li>';
            });

            surveyPreviewHTML += '</ol>';

            // Display the survey preview in a SweetAlert
            Swal.fire({
                title: 'Survey Preview',
                html: surveyPreviewHTML,
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'Looks Good!',
                cancelButtonText: 'Edit Survey',
                customClass: {
                    popup: 'swal2-custom-popup',
                },
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const responsesTable = document.getElementById('responsesTable');

            // Use event delegation to handle clicks on dynamically added buttons
            responsesTable.addEventListener('click', async (e) => {
                if (e.target.classList.contains('btnReview')) {
                    const surveyId = e.target.getAttribute('data-survey');
                    const userId = e.target.getAttribute('data-student'); // Ensure this attribute exists

                    // Log the surveyId and userId for debugging
                    console.log('Survey ID:', surveyId);
                    console.log('User ID:', userId);

                    if (surveyId && userId) {
                        await openSurveyForReview(surveyId, userId);
                    } else {
                        Swal.fire('Error', 'Survey ID or User ID is missing. Please try again.', 'error');
                    }
                }
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const responsesTable = document.getElementById('responsesTable');

            // Use event delegation to handle clicks on dynamically added buttons
            responsesTable.addEventListener('click', async (e) => {
                if (e.target.classList.contains('btnReview')) {
                    const surveyId = e.target.getAttribute('data-survey');
                    if (surveyId) {
                        await openSurveyForReview(surveyId, userId);
                    } else {
                        Swal.fire('Error', 'Survey ID is missing. Please try again.', 'error');
                    }
                }
            });

            async function openSurveyForReview(surveyId, userId) {
                try {
                    // Fetch survey questions
                    const surveyResponse = await fetch(`http://localhost:8000/survey/${surveyId}`);
                    if (!surveyResponse.ok) {
                        throw new Error('Failed to fetch survey details');
                    }
                    const survey = await surveyResponse.json();

                    // Fetch student answers
                    const answersResponse = await fetch(`http://localhost:8000/test?survey=${surveyId}&userID=${userId}`);
                    if (!answersResponse.ok) {
                        throw new Error('Failed to fetch student answers');
                    }
                    const studentAnswers = await answersResponse.json();

                    // Populate the modal with survey questions and student answers
                    const surveyQuestionsContainer = document.getElementById('surveyQuestionsContainer');
                    surveyQuestionsContainer.innerHTML = ''; // Clear existing content

                    survey.questions.forEach((question, index) => {
                        // Find the student's answer for this question
                        const studentAnswer = studentAnswers.find(answer => answer.QuestionID === question.questionID);

                        let questionHTML = `<div class="mb-3">
                            <p><strong>${index + 1}. ${question.questionTitle}</strong></p>`;

                        if (question.questionType === 'multipleChoice') {
                            questionHTML += '<ul style="list-style-type: none; padding-left: 0;">';
                            question.answerChoices.forEach((choice, i) => {
                                const letter = String.fromCharCode(65 + i); // Convert index to A, B, C, etc.
                                const isSelected = studentAnswer && studentAnswer.Contents === choice; // Check if this choice was selected
                                questionHTML += `
                                    <li>
                                        <input type="radio" name="question${index}" id="question${index}_choice${i}" value="${choice}" ${isSelected ? 'checked' : ''} disabled>
                                        <label for="question${index}_choice${i}">${letter}. ${choice}</label>
                                    </li>`;
                            });
                            questionHTML += '</ul>';
                        } else if (question.questionType === 'shortAnswer') {
                            questionHTML += `<textarea class="form-control" name="question${index}" rows="3" disabled>${studentAnswer ? studentAnswer.Contents : ''}</textarea>`;
                        } else if (question.questionType === 'likert') {
                            questionHTML += `
                                <div>
                                    ${[1, 2, 3, 4, 5]
                                        .map(
                                            (value) => `
                                        <label>${value}</label>
                                        <input type="radio" name="question${index}" value="${value}" ${studentAnswer && studentAnswer.Contents == value ? 'checked' : ''} disabled>
                                    `
                                        )
                                        .join('')}
                                </div>`;
                        }

                        questionHTML += '</div>';
                        surveyQuestionsContainer.innerHTML += questionHTML;
                    });

                    // Show the modal
                    const surveyModal = new bootstrap.Modal(document.getElementById('surveyModal'));
                    surveyModal.show();
                } catch (error) {
                    console.error('Error opening survey:', error);
                    Swal.fire('Error', 'Failed to load the survey. Please try again later.', 'error');
                }
            }
        });
    </script>

    <div class="modal fade" id="surveyModal" tabindex="-1" aria-labelledby="surveyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="surveyModalLabel">Survey Review</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="surveyQuestionsContainer">
                        <!-- Survey questions and answers will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function openSurveyForReview(surveyId, userId) {

            const answersResponse = await fetch(`http://localhost:8000/test?survey=${surveyId}&userID=${userId}`);
                if (!answersResponse.ok) {
                    console.error('Failed to fetch student answers:', answersResponse.statusText);
                    throw new Error('Failed to fetch student answers');
                }
                const studentAnswers = await answersResponse.json();
                console.log("hello");
                console.log(studentAnswers);
                console.log("goodbye");
            
                // Fetch survey questions
                const surveyResponse = await fetch(`http://localhost:8000/survey/${surveyId}`);
                if (!surveyResponse.ok) {
                    throw new Error('Failed to fetch survey details');
                }
                const survey = await surveyResponse.json();

                // Fetch student answers
               

                // Populate the modal with survey questions and student answers
                const surveyQuestionsContainer = document.getElementById('surveyQuestionsContainer');
                surveyQuestionsContainer.innerHTML = ''; // Clear existing content

                survey.questions.forEach((question, index) => {
                    // Get the corresponding answer by index
                    const studentAnswer = studentAnswers[index];

                    let questionHTML = `<div class="mb-3">
                        <p><strong>${index + 1}. ${question.questionTitle}</strong></p>`;

                    if (question.questionType === 'multipleChoice') {
                        questionHTML += '<ul style="list-style-type: none; padding-left: 0;">';
                        question.answerChoices.forEach((choice, i) => {
                            const letter = String.fromCharCode(65 + i); // Convert index to A, B, C, etc.
                            const isSelected = studentAnswer && studentAnswer.Contents === choice; // Check if this choice was selected
                            questionHTML += `
                                <li>
                                    <input type="radio" name="question${index}" id="question${index}_choice${i}" value="${choice}" ${isSelected ? 'checked' : ''} disabled>
                                    <label for="question${index}_choice${i}">${letter}. ${choice}</label>
                                </li>`;
                        });
                        questionHTML += '</ul>';
                    } else if (question.questionType === 'shortAnswer') {
                        questionHTML += `<textarea class="form-control" name="question${index}" rows="3" disabled>${studentAnswer ? studentAnswer.Contents : ''}</textarea>`;
                    } else if (question.questionType === 'likert') {
                        questionHTML += `
                            <div>
                                ${[1, 2, 3, 4, 5]
                                    .map(
                                        (value) => `
                                    <label>${value}</label>
                                    <input type="radio" name="question${index}" value="${value}" ${studentAnswer && studentAnswer.Contents == value ? 'checked' : ''} disabled>
                                `
                                    )
                                    .join('')}
                            </div>`;
                    }

                    questionHTML += '</div>';
                    surveyQuestionsContainer.innerHTML += questionHTML;
                });

                // Show the modal
                const surveyModal = new bootstrap.Modal(document.getElementById('surveyModal'));
                surveyModal.show();
            
        }
    </script>
    <script>
    // Define the openSurveyForReview function here
    

    // Add the event listener
    document.addEventListener('DOMContentLoaded', () => {
        const responsesTable = document.getElementById('responsesTable');

        responsesTable.addEventListener('click', async (e) => {
            if (e.target.classList.contains('btnReview')) {
                const surveyId = e.target.getAttribute('data-survey');
                const userId = e.target.getAttribute('data-student');

                console.log('Survey ID:', surveyId);
                console.log('User ID:', userId);

                if (surveyId && userId) {
                    await openSurveyForReview(surveyId, userId);
                } else {
                    Swal.fire('Error', 'Survey ID or User ID is missing. Please try again.', 'error');
                }
            }
        });
    });
</script>
<script>
    async function fetchCompletedSurveys() {
        try {
            console.log("Starting fetchCompletedSurveys..."); // Debugging

            // Validate token and retrieve UserID
            const token = localStorage.getItem('jwt'); // Assuming the token is stored in localStorage
            console.log("Token retrieved:", token); // Debugging

            const validateResponse = await fetch('http://localhost:8000/ValidateToken', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                },
            });

            if (!validateResponse.ok) {
                throw new Error('Failed to validate token');
            }

            const validateData = await validateResponse.json();
            const userID = validateData.userID; // Extract UserID from the response
            console.log("UserID retrieved from ValidateToken:", userID); // Debugging

            // Call the completed-surveys route
            const response = await fetch(`http://localhost:8000/completed-surveys/${userID}`);
            if (!response.ok) {
                throw new Error('Failed to fetch completed surveys');
            }

            const completedSurveys = await response.json();
            console.log("Completed surveys fetched:", completedSurveys); // Debugging

            // Get the table body element
            const responsesTable = document.getElementById('responsesTable');
            responsesTable.innerHTML = ''; // Clear existing rows

            // Extract unique survey names and class names
            const surveyNames = new Set();
            const classNames = new Set();

            // Populate the table with survey data
            for (const survey of completedSurveys) {
                console.log("Processing survey:", survey); // Debugging

                const row = document.createElement('tr');

                // Fetch the class name using the classId route if surveyId is available
                let className = 'Unknown Class';
                if (survey.surveyId) {
                    try {
                        const classResponse = await fetch(`http://localhost:8000/classId/${survey.surveyId}`);
                        if (classResponse.ok) {
                            const classData = await classResponse.json();
                            className = classData.classId || 'Unknown Class';
                        }
                    } catch (error) {
                        console.error(`Error fetching class for SurveyID ${survey.surveyId}:`, error);
                    }
                }

                // Add survey name and class name to the sets
                if (survey.surveyName) surveyNames.add(survey.surveyName);
                if (className) classNames.add(className);

                // Populate the row with userId
                row.innerHTML = `
                    <td>${survey.student || 'Unknown Student'}</td> 
                    <td>${survey.surveyName || 'Unknown Survey'}</td> 
                    <td>${className}</td> 
                    <td>submitted</td> 
                    <td>
                        <button class="btn btn-primary btn-sm btnReview" 
                            data-survey="${survey.surveyId}" 
                            data-student="${survey.userId}">
                            Review
                        </button>
                    </td>
                `;
                responsesTable.appendChild(row);
            }

            console.log("Survey table populated successfully."); // Debugging

            // Populate the survey filter dropdown
            const surveyFilter = document.getElementById('responseSurveyFilter');
            surveyFilter.innerHTML = '<option value="all" selected>All Surveys</option>';
            surveyNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                surveyFilter.appendChild(option);
            });

            // Populate the class filter dropdown
            const classFilter = document.getElementById('responseClassFilter');
            classFilter.innerHTML = '<option value="all" selected>All Classes</option>';
            classNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                classFilter.appendChild(option);
            });

            console.log("Filters populated successfully."); // Debugging

            // Add event listeners for filtering
            surveyFilter.addEventListener('change', filterTable);
            classFilter.addEventListener('change', filterTable);

        } catch (error) {
            console.error('Error fetching completed surveys:', error);
        }
    }

    // Call the function when the page loads
    document.addEventListener('DOMContentLoaded', fetchCompletedSurveys);
</script>
</body>

</html>